<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light" />
  <title>Platform Shock ‚Äî Tech Power Basics</title>
  <style>
    :root{
      --bg:#f5f7ff;
      --panel:#ffffff;
      --panel2:#eef2ff;
      --text:#101828;
      --muted:#475467;
      --accent:#4f46e5;
      --accent2:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
      --line:#e5e7eb;
      --chip:#f1f5f9;
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    * { box-sizing: border-box; }
    body{
      margin:0;
      background:
        radial-gradient(1100px 680px at 0% 0%, rgba(79,70,229,.12), transparent 55%),
        radial-gradient(900px 600px at 100% 10%, rgba(34,197,94,.10), transparent 50%),
        var(--bg);
      color:var(--text);
      font-family:var(--sans);
    }
    header{
      padding: 18px 18px 10px;
      position: sticky; top:0; z-index:20;
      background: rgba(245,247,255,.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--line);
    }
    header .top{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      max-width: 1100px; margin: 0 auto;
    }
    h1{ margin:0; font-size: 20px; letter-spacing:.2px; }
    .subtitle{ margin-top:4px; color:var(--muted); font-size: 14px; max-width: 820px; line-height:1.45; }
    .pillrow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill{
      background: var(--chip);
      border: 1px solid var(--line);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      display:flex; align-items:center; gap:6px;
    }
    .pill strong{ color: var(--text); font-weight:600; }
    .pillbutton{
      background: var(--chip);
      border: 1px solid var(--line);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      display:flex; align-items:center; gap:6px;
      cursor:pointer;
    }
    .pillbutton:hover{ background:#eaf0ff; }
    .container{
      max-width: 1100px; margin: 16px auto 60px; padding: 0 18px;
      display:grid; gap: 14px;
    }
    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding: 14px 16px 10px;
      font-size: 15px; font-weight: 650;
      border-bottom: 1px solid var(--line);
      background: var(--panel2);
      display:flex; gap:8px; align-items:center;
    }
    .card .body{ padding: 16px; }
    .muted{ color: var(--muted); }
    .intro-grid{
      display:grid; gap: 12px;
      grid-template-columns: 2fr 1fr;
    }
    @media (max-width: 900px){
      .intro-grid{ grid-template-columns: 1fr; }
    }
    .quicklist{
      display:grid; gap:6px; margin: 0; padding-left: 18px; color: var(--muted);
      font-size: 13px; line-height: 1.4;
    }
    .legend{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      font-size: 12px; color: var(--muted);
      margin-top: 10px;
    }
    .dot{
      width: 10px; height: 10px; border-radius: 999px; display:inline-block; margin-right:6px;
    }
    .dot.rnd{ background: #6366f1; }
    .dot.dep{ background: #f97316; }
    .dot.reg{ background: #06b6d4; }
    .dot.work{ background: #22c55e; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 680px){ .grid2{ grid-template-columns: 1fr; } }
    .btnbar{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      background: rgba(79,70,229,.12);
      color: var(--text);
      border: 1px solid rgba(79,70,229,.25);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      cursor:pointer;
      transition: transform .04s ease, background .15s ease, border .15s ease;
      user-select:none;
    }
    button:hover{ background: rgba(79,70,229,.18); }
    button:active{ transform: translateY(1px); }
    button.secondary{
      background: #ffffff;
      border: 1px solid var(--line);
    }
    button.secondary:hover{ background: #f8fafc; }
    button.danger{
      background: rgba(239,68,68,.12);
      border: 1px solid rgba(239,68,68,.28);
    }
    button.danger:hover{ background: rgba(239,68,68,.18); }
    button.good{
      background: rgba(34,197,94,.14);
      border: 1px solid rgba(34,197,94,.35);
    }
    button.good:hover{ background: rgba(34,197,94,.2); }
    button:disabled{ opacity:.5; cursor:not-allowed; }
    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
      background: #fff;
    }
    .table th, .table td{
      padding: 10px 10px;
      border-bottom: 1px solid var(--line);
      text-align:left;
      vertical-align: top;
    }
    .table th{ color: var(--muted); font-weight: 650; background: #f8fafc; }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top: 10px;
    }
    .chip{
      background: var(--chip);
      border: 1px solid var(--line);
      padding: 7px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .chip strong{ color: var(--text); font-weight: 650; }
    .sliders{ display:grid; gap:10px; }
    .sliderrow{
      display:grid; grid-template-columns: 150px 1fr 60px;
      gap:10px; align-items:center;
      font-size: 12px; color: var(--muted);
    }
    input[type="range"]{ width:100%; accent-color: var(--accent); }
    .num{
      font-family: var(--mono);
      color: var(--text);
      text-align:right;
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 6px 8px;
    }
    .scorebox{
      display:grid; grid-template-columns: 1fr 1fr;
      gap:10px; margin-top: 12px;
    }
    .scorecard{
      background: #f8fafc;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .scorecard .label{ color: var(--muted); font-size: 12px; }
    .scorecard .value{ font-family: var(--mono); font-size: 16px; margin-top: 4px; }
    .ranklist{ margin-top: 10px; display:grid; gap:8px; }
    .rankitem{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
      display:grid;
      gap:6px;
    }
    .ranktop{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
    }
    .rankitem .left{ display:flex; gap:10px; align-items:center; min-width: 0; }
    .badge{
      width: 22px; height: 22px; border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      font-size: 12px; font-family: var(--mono);
      background: rgba(79,70,229,.14);
      border: 1px solid rgba(79,70,229,.35);
      flex: 0 0 auto;
    }
    .rankitem .country{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .rankitem .score{ font-family: var(--mono); color: var(--text); }
    .rankbar{ height: 8px; background: #eef2ff; border-radius: 999px; overflow:hidden; }
    .rankfill{ height:100%; background: linear-gradient(90deg, #4f46e5, #22c55e); width:0%; }
    .scenario{
      background: #f8fafc;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .scenario h3{ margin:0 0 6px; font-size: 13px; }
    .scenario p{ margin:0; color: var(--muted); font-size: 12px; line-height:1.45; }
    .roles{ display:grid; gap:10px; }
    .rolecard{
      background: #fff;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 12px;
    }
    .rolehead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom: 8px;
    }
    .rolehead .name{ font-size: 13px; font-weight: 650; }
    .rolehead .tag{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: #f8fafc;
      border: 1px solid var(--line);
      color: var(--muted);
      white-space:nowrap;
    }
    .rolecard ul{
      margin: 8px 0 0 18px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .inputs{ display:grid; gap:10px; margin-top: 10px; }
    textarea, select, input[type="text"]{
      width:100%;
      background: #fff;
      border: 1px solid var(--line);
      color: var(--text);
      border-radius: 12px;
      padding: 10px;
      font-size: 13px;
      outline:none;
    }
    textarea{ min-height: 110px; resize: vertical; }
    .row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
    @media (max-width: 520px){ .row{ grid-template-columns: 1fr; } }
    .timer{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background: #f8fafc;
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 10px;
    }
    .timer .tleft{ color: var(--muted); font-size: 12px; }
    .timer .tvalue{ font-family: var(--mono); font-size: 16px; }
    .progress{
      height: 10px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid var(--line);
      overflow:hidden;
      margin-top: 8px;
    }
    .bar{ height:100%; width:0%; background: linear-gradient(90deg, #4f46e5, #22c55e); }
    .footer{ color: var(--muted); font-size: 12px; margin-top: 12px; line-height:1.45; }
    .small{ font-size: 12px; color: var(--muted); }
    .hr{ height:1px; background: var(--line); margin: 12px 0; }
    .hidden{ display:none !important; }
    .mono{ font-family: var(--mono); }
  </style>
</head>

<body>
<header>
  <div class="top">
    <div>
      <h1>Platform Shock ‚Äî Tech Power Basics</h1>
      <div class="subtitle">
        A short, easy-to-run class simulation. Students adjust simple indicators, see rankings update,
        then choose a response to a sudden platform cutoff.
      </div>
    </div>
    <div class="pillrow">
      <div class="pill"><strong>Phase</strong> <span id="phaseLabel">Setup</span></div>
      <div class="pill"><strong>Timer</strong> <span id="timerMini">--:--</span></div>
      <button class="pillbutton" type="button" id="exportPill" aria-label="Scroll to export section">
        <strong>Export</strong> <span class="mono">JSON/CSV</span>
      </button>
    </div>
  </div>
</header>

<div class="container">
  <section class="card">
    <h2>üöÄ Quick start</h2>
    <div class="body intro-grid">
      <div class="small">
        <strong>Goal:</strong> practice linking numbers to political judgment. Use the table + weights,
        then justify a choice in plain language.
      </div>
      <ul class="quicklist">
        <li>Step 1: adjust weights (sliders).</li>
        <li>Step 2: read the scenario.</li>
        <li>Step 3: pick a role + decision.</li>
        <li>Step 4: export for debrief.</li>
      </ul>
    </div>
  </section>

  <section class="card">
    <h2>1) Simple indicators ‚Üí leverage score</h2>
    <div class="body">
      <div class="small">
        Use four indicators only. The values are illustrative and just for discussion.
      </div>

      <div class="legend">
        <span><span class="dot rnd"></span>R&amp;D</span>
        <span><span class="dot dep"></span>Dependency (lower is better)</span>
        <span><span class="dot reg"></span>Regulation</span>
        <span><span class="dot work"></span>Workforce</span>
      </div>

      <table class="table" id="dataTable" aria-label="Technology leverage indicators table"></table>

      <div class="kpi">
        <span class="chip"><strong>Scores:</strong> 0‚Äì100</span>
        <span class="chip"><strong>Weights:</strong> auto-normalized</span>
        <span class="chip"><strong>Tip:</strong> move one slider a lot to see shifts</span>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <div class="muted" style="font-size:12px; margin-bottom:8px;">Adjust weights (drag sliders)</div>
          <div class="sliders">
            <div class="sliderrow">
              <label for="wRnD">R&amp;D (% GDP)</label>
              <input id="wRnD" type="range" min="0" max="100" value="30" />
              <div class="num" id="wRnDVal">0.30</div>
            </div>
            <div class="sliderrow">
              <label for="wDep">Platform dependency</label>
              <input id="wDep" type="range" min="0" max="100" value="25" />
              <div class="num" id="wDepVal">0.25</div>
            </div>
            <div class="sliderrow">
              <label for="wReg">Regulatory capacity</label>
              <input id="wReg" type="range" min="0" max="100" value="25" />
              <div class="num" id="wRegVal">0.25</div>
            </div>
            <div class="sliderrow">
              <label for="wWork">Tech workforce density</label>
              <input id="wWork" type="range" min="0" max="100" value="20" />
              <div class="num" id="wWorkVal">0.20</div>
            </div>
          </div>

          <div class="scorebox">
            <div class="scorecard">
              <div class="label">Weight sum</div>
              <div class="value" id="weightSum">1.00</div>
            </div>
            <div class="scorecard">
              <div class="label">Dominant lens</div>
              <div class="value" id="cueText" style="font-size:13px; font-family:var(--sans);">Balanced</div>
            </div>
          </div>

          <div class="btnbar" style="margin-top:12px;">
            <button class="secondary" type="button" id="resetWeights">Reset weights</button>
            <button class="secondary" type="button" id="randomWeights">Random weights</button>
          </div>
        </div>

        <div>
          <div class="muted" style="font-size:12px; margin-bottom:8px;">Live ranking (updates as you drag)</div>
          <div class="ranklist" id="rankList"></div>
          <div class="footer">
            Discussion prompt: ‚ÄúWho moved most when weights changed, and why?‚Äù
          </div>
        </div>
      </div>
    </div>
  </section>

  <section class="card">
    <h2>2) Scenario ‚Üí choose a response</h2>
    <div class="body">
      <div class="scenario">
        <h3>Scenario: ‚ÄúPlatform Shock‚Äù</h3>
        <p>
          A major cloud/AI platform cuts access after a political dispute. Some actors lose models and compute
          within <span class="mono">72 hours</span>.
        </p>
      </div>

      <div class="scenario">
        <h3>Your task (2‚Äì3 minutes)</h3>
        <p>
          Pick a response and justify it using one table indicator. Link your reasoning to
          <span class="mono">capability</span>, <span class="mono">control</span>, or <span class="mono">legitimacy</span>.
        </p>
      </div>
    </div>
  </section>

  <section class="card" id="decisionCard">
    <h2>3) Roles, timer, and decision form</h2>
    <div class="body">
      <div class="timer">
        <div>
          <div class="tleft">Class timer</div>
          <div class="tvalue" id="timerMain">--:--</div>
          <div class="progress" aria-hidden="true"><div class="bar" id="timeBar"></div></div>
        </div>
        <div class="btnbar">
          <button class="good" type="button" id="startBtn">Start 5:00</button>
          <button class="secondary" type="button" id="pauseBtn" disabled>Pause</button>
          <button class="danger" type="button" id="resetBtn">Reset</button>
        </div>
      </div>

      <div class="small">
        Click <span class="mono">Start</span>, assign roles, then save the group‚Äôs decision.
      </div>

      <div class="hr"></div>

      <div class="btnbar">
        <button class="secondary" type="button" id="assignRolesBtn">Auto-assign roles (10 people)</button>
        <button class="secondary" type="button" id="clearRolesBtn">Clear roles</button>
      </div>

      <div class="roles" id="rolesArea" style="margin-top:10px;"></div>

      <div class="hr"></div>

      <div class="muted" style="font-size:12px; margin-bottom:8px;">Group decision input (pick your role)</div>
      <div class="inputs">
        <div class="row">
          <select id="roleSelect" aria-label="Select role">
            <option value="">Select your role‚Ä¶</option>
          </select>
          <select id="actionSelect" aria-label="Select action">
            <option value="">Choose action‚Ä¶</option>
            <option>Regulate / mandate compliance</option>
            <option>Substitute / build domestic capacity</option>
            <option>Bargain / offer concessions for access</option>
            <option>Align / join bloc or standards regime</option>
            <option>Stabilize / diversify suppliers quietly</option>
            <option>Retaliate / restrict market access</option>
          </select>
        </div>

        <div class="row">
          <select id="indicatorSelect" aria-label="Select indicator to justify">
            <option value="">Indicator used for justification‚Ä¶</option>
            <option value="rnd">R&amp;D (% GDP)</option>
            <option value="dep">Foreign platform dependency (%)</option>
            <option value="reg">Regulatory capacity (0‚Äì5)</option>
            <option value="work">Tech workforce density (per 1,000)</option>
          </select>
          <input id="capCtrlLeg" type="text" placeholder="Link to: capability / control / legitimacy" aria-label="Link to concept" />
        </div>

        <textarea id="justification" placeholder="Write a short justification (2‚Äì4 sentences)." aria-label="Justification text"></textarea>

        <div class="btnbar">
          <button class="good" type="button" id="saveDecisionBtn">Save decision</button>
          <button class="secondary" type="button" id="loadMyDecisionBtn">Load saved</button>
        </div>

        <div class="small" id="saveStatus" aria-live="polite"></div>
      </div>

      <div class="hr"></div>

      <div class="btnbar">
        <button class="secondary" type="button" id="exportJsonBtn">Export JSON</button>
        <button class="secondary" type="button" id="exportCsvBtn">Export CSV</button>
        <button class="secondary" type="button" id="copyDebriefBtn">Copy debrief prompts</button>
      </div>

      <div class="footer">
        Debrief prompts focus on constraints, capability vs leverage, and small-state strategy.
      </div>
    </div>
  </section>
</div>

<script>
(() => {
  "use strict";

  const countries = [
    { country: "United States", rnd: 3.5, dep: 20, reg: 4.5, work: 9.0 },
    { country: "China",         rnd: 2.6, dep: 15, reg: 4.0, work: 7.5 },
    { country: "European Union",rnd: 2.3, dep: 35, reg: 5.0, work: 6.8 },
    { country: "UAE",           rnd: 1.5, dep: 55, reg: 3.5, work: 4.2 },
    { country: "Qatar",         rnd: 1.0, dep: 60, reg: 3.0, work: 3.8 },
    { country: "India",         rnd: 0.7, dep: 40, reg: 2.5, work: 5.0 }
  ];

  const metricMeta = {
    rnd:  { label: "R&D Expenditure (% GDP)", higherBetter: true },
    dep:  { label: "Foreign Platform Dependency (%)", higherBetter: false },
    reg:  { label: "Regulatory Capacity (0‚Äì5)", higherBetter: true },
    work: { label: "Tech Workforce Density (per 1,000)", higherBetter: true }
  };

  const $ = (sel) => document.querySelector(sel);
  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k === "class") n.className = v;
      else if (k === "html") n.innerHTML = v;
      else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
      else n.setAttribute(k, v);
    }
    for (const c of children) n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
    return n;
  };

  function renderTable() {
    const table = $("#dataTable");
    table.innerHTML = "";

    const caption = el("caption", { class: "small", style: "caption-side: top; text-align:left; padding: 8px 10px;" }, [
      "Illustrative indicators used for in-class discussion (not empirical claims)."
    ]);
    table.appendChild(caption);

    const thead = el("thead");
    const trh = el("tr");
    trh.appendChild(el("th", {}, ["Country"]));
    trh.appendChild(el("th", {}, ["R&D (% GDP)"]));
    trh.appendChild(el("th", {}, ["Platform dependency (%)"]));
    trh.appendChild(el("th", {}, ["Reg. capacity (0‚Äì5)"]));
    trh.appendChild(el("th", {}, ["Tech workforce (/1,000)"]));
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = el("tbody");
    for (const r of countries) {
      const tr = el("tr");
      tr.appendChild(el("td", {}, [r.country]));
      tr.appendChild(el("td", {}, [String(r.rnd)]));
      tr.appendChild(el("td", {}, [String(r.dep)]));
      tr.appendChild(el("td", {}, [String(r.reg)]));
      tr.appendChild(el("td", {}, [String(r.work)]));
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
  }

  function minMax(metric) {
    const vals = countries.map(c => c[metric]);
    return { min: Math.min(...vals), max: Math.max(...vals) };
  }

  function norm(value, metric) {
    const { min, max } = minMax(metric);
    if (max === min) return 50;
    let x = (value - min) / (max - min);
    if (!metricMeta[metric].higherBetter) x = 1 - x;
    return x * 100;
  }

  function getWeights() {
    const raw = {
      rnd: Number($("#wRnD").value),
      dep: Number($("#wDep").value),
      reg: Number($("#wReg").value),
      work: Number($("#wWork").value)
    };
    const total = raw.rnd + raw.dep + raw.reg + raw.work;
    const w = {};
    for (const k of Object.keys(raw)) w[k] = total ? raw[k]/total : 0.25;
    return w;
  }

  function updateWeightDisplays() {
    const w = getWeights();
    $("#wRnDVal").textContent = w.rnd.toFixed(2);
    $("#wDepVal").textContent = w.dep.toFixed(2);
    $("#wRegVal").textContent = w.reg.toFixed(2);
    $("#wWorkVal").textContent = w.work.toFixed(2);
    $("#weightSum").textContent = (w.rnd+w.dep+w.reg+w.work).toFixed(2);

    const entries = Object.entries(w).sort((a,b)=>b[1]-a[1]);
    const [topK, topV] = entries[0];
    const cueMap = {
      rnd: "Innovation focus",
      dep: "Autonomy focus",
      reg: "Governance focus",
      work: "Workforce focus"
    };
    $("#cueText").textContent = (topV >= 0.40) ? cueMap[topK] : "Balanced";
  }

  function computeScores() {
    const w = getWeights();
    return countries.map(c => {
      const s = (
        norm(c.rnd,"rnd")  * w.rnd +
        norm(c.dep,"dep")  * w.dep +
        norm(c.reg,"reg")  * w.reg +
        norm(c.work,"work")* w.work
      );
      return { ...c, score: s };
    }).sort((a,b)=>b.score - a.score);
  }

  function renderRanks() {
    const list = $("#rankList");
    list.innerHTML = "";
    const scored = computeScores();
    scored.forEach((c, idx) => {
      const fill = el("div", { class:"rankfill" });
      fill.style.width = `${Math.max(0, Math.min(100, c.score))}%`;
      list.appendChild(
        el("div", { class:"rankitem" }, [
          el("div", { class:"ranktop" }, [
            el("div", { class:"left" }, [
              el("div", { class:"badge" }, [String(idx+1)]),
              el("div", { class:"country" }, [c.country])
            ]),
            el("div", { class:"score" }, [c.score.toFixed(1)])
          ]),
          el("div", { class:"rankbar" }, [fill])
        ])
      );
    });
  }

  function setSlidersFromWeights(w) {
    const raw = {
      rnd: Math.round(w.rnd*100),
      dep: Math.round(w.dep*100),
      reg: Math.round(w.reg*100),
      work: Math.round(w.work*100)
    };
    const keys = ["rnd","dep","reg","work"];
    let s = keys.reduce((acc,k)=>acc+raw[k],0);
    while (s !== 100) {
      const k = keys[Math.floor(Math.random()*keys.length)];
      raw[k] += (s > 100 ? -1 : 1);
      s = keys.reduce((acc,kk)=>acc+raw[kk],0);
    }
    $("#wRnD").value = raw.rnd;
    $("#wDep").value = raw.dep;
    $("#wReg").value = raw.reg;
    $("#wWork").value = raw.work;
  }

  function resetWeights() {
    $("#wRnD").value = 30;
    $("#wDep").value = 25;
    $("#wReg").value = 25;
    $("#wWork").value = 20;
    onWeightsChanged();
  }

  function randomWeights() {
    const r = [Math.random(),Math.random(),Math.random(),Math.random()];
    const sum = r.reduce((a,b)=>a+b,0);
    setSlidersFromWeights({ rnd:r[0]/sum, dep:r[1]/sum, reg:r[2]/sum, work:r[3]/sum });
    onWeightsChanged();
  }

  function onWeightsChanged() {
    updateWeightDisplays();
    renderRanks();
  }

  const roleTemplates = [
    { id:"US", name:"Large Tech-Producing State A (US-like)", tag:"State", bullets:[
      "High capability: R&D + workforce.",
      "Can restrict exports or deny access.",
      "Trade-off: credibility vs market backlash."
    ]},
    { id:"CN", name:"Large Tech-Producing State B (China-like)", tag:"State", bullets:[
      "Strong scaling capacity + domestic market.",
      "Can offer substitutes, but political strings.",
      "Trade-off: autonomy vs legitimacy."
    ]},
    { id:"SM1", name:"Small, capital-rich state (Gulf-like) ‚Äî Group 1", tag:"State", bullets:[
      "High dependence on foreign platforms.",
      "Can buy redundancy and diversify suppliers.",
      "Trade-off: speed vs sovereignty."
    ]},
    { id:"SM2", name:"Small, capital-rich state (Gulf-like) ‚Äî Group 2", tag:"State", bullets:[
      "Seeks reputation and regime stability.",
      "Can invest in compute and standards.",
      "Trade-off: openness vs control."
    ]},
    { id:"PF1", name:"Platform Firm A (Cloud/AI provider)", tag:"Firm", bullets:[
      "Controls access via terms-of-service.",
      "Can throttle, exempt, or reprice.",
      "Trade-off: market share vs regulation."
    ]},
    { id:"PF2", name:"Platform Firm B (Alternative provider)", tag:"Firm", bullets:[
      "Can absorb demand displaced by shock.",
      "May offer migration tools/credits.",
      "Trade-off: growth vs exposure."
    ]},
    { id:"REG1", name:"Regulator / Standards Bloc A (EU-like)", tag:"Institution", bullets:[
      "Sets compliance terms; claims legitimacy through law.",
      "Can impose fines, audits, transparency rules.",
      "Trade-off: innovation vs authority."
    ]},
    { id:"REG2", name:"International Institution / Multilateral Forum", tag:"Institution", bullets:[
      "Can convene and coordinate norms.",
      "Limited enforcement; relies on buy-in.",
      "Trade-off: inclusivity vs speed."
    ]}
  ];

  function buildSeatsForTen() {
    const seats = [...roleTemplates];
    seats.push({ ...roleTemplates.find(r=>r.id==="SM1"), id:"SM1B", name:"Small, capital-rich state (Gulf-like) ‚Äî Group 3" });
    seats.push({ ...roleTemplates.find(r=>r.id==="PF1"), id:"PF1B", name:"Platform Firm A (Cloud/AI provider) ‚Äî Group 2" });
    return seats;
  }

  const state = {
    phase: "Setup",
    seats: buildSeatsForTen(),
    assignments: [],
    decisions: {},
    timer: { totalSec: 300, remainingSec: 300, running: false, interval: null }
  };

  function setPhase(p) {
    state.phase = p;
    $("#phaseLabel").textContent = p;
  }

  function renderRoles() {
    const area = $("#rolesArea");
    area.innerHTML = "";

    const assignedMap = new Map(state.assignments.map(a => [a.seatId, a.participantName]));
    state.seats.forEach(seat => {
      const who = assignedMap.get(seat.id) || "";
      area.appendChild(
        el("div", { class:"rolecard" }, [
          el("div", { class:"rolehead" }, [
            el("div", { class:"name" }, [seat.name]),
            el("div", { class:"tag" }, [seat.tag + (who ? ` ‚Ä¢ ${who}` : "")])
          ]),
          el("div", { class:"small" }, ["Constraints & options:"]),
          el("ul", {}, seat.bullets.map(b => el("li", {}, [b])))
        ])
      );
    });

    const roleSel = $("#roleSelect");
    const current = roleSel.value;
    roleSel.innerHTML = `<option value="">Select your role‚Ä¶</option>`;
    state.seats.forEach(seat => {
      const opt = document.createElement("option");
      opt.value = seat.id;
      opt.textContent = seat.name;
      roleSel.appendChild(opt);
    });
    roleSel.value = current && state.seats.some(s=>s.id===current) ? current : "";
  }

  function autoAssignRoles() {
    state.assignments = [];
    const names = Array.from({length: 10}, (_,i)=>`P${i+1}`);
    const shuffled = [...state.seats].sort(()=>Math.random()-0.5);
    for (let i=0; i<Math.min(names.length, shuffled.length); i++) {
      state.assignments.push({ seatId: shuffled[i].id, participantName: names[i] });
    }
    renderRoles();
    flashStatus("Roles assigned (P1‚ÄìP10). Edit names in exported JSON if needed.");
  }

  function clearRoles() {
    state.assignments = [];
    renderRoles();
    flashStatus("Roles cleared.");
  }

  function fmtTime(sec) {
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  function updateTimerUI() {
    $("#timerMain").textContent = fmtTime(state.timer.remainingSec);
    $("#timerMini").textContent = fmtTime(state.timer.remainingSec);
    const pct = 100 * (1 - state.timer.remainingSec / state.timer.totalSec);
    $("#timeBar").style.width = `${Math.min(100, Math.max(0, pct))}%`;
  }

  function stopTimer() {
    if (state.timer.interval) {
      clearInterval(state.timer.interval);
      state.timer.interval = null;
    }
    state.timer.running = false;
    $("#startBtn").disabled = false;
    $("#pauseBtn").disabled = true;
  }

  function startTimer() {
    if (state.timer.running) return;
    stopTimer(); // hard reset any stray interval
    setPhase("Decision (5 minutes)");
    state.timer.running = true;
    $("#startBtn").disabled = true;
    $("#pauseBtn").disabled = false;

    state.timer.interval = setInterval(() => {
      state.timer.remainingSec = Math.max(0, state.timer.remainingSec - 1);
      updateTimerUI();
      if (state.timer.remainingSec === 0) {
        stopTimer();
        setPhase("Debrief");
        flashStatus("Time. Move to debrief prompts.");
      }
    }, 1000);
  }

  function pauseTimer() {
    if (!state.timer.running) return;
    stopTimer();
    setPhase("Paused");
  }

  function resetTimer() {
    stopTimer();
    state.timer.remainingSec = state.timer.totalSec;
    updateTimerUI();
    setPhase("Setup");
  }

  const LS_KEY = "platform_shock_sim_v1";

  function getSnapshot() {
    const ranking = computeScores().map(c => ({ country: c.country, score: Number(c.score.toFixed(1)) }));
    return {
      meta: {
        title: "Platform Shock ‚Äî Tech Power Basics",
        createdAt: new Date().toISOString(),
        phase: state.phase
      },
      data: { countries },
      weights: getWeights(),
      ranking,
      assignments: state.assignments,
      decisions: state.decisions,
      timer: { totalSec: state.timer.totalSec, remainingSec: state.timer.remainingSec }
    };
  }

  function flashStatus(msg, isError=false) {
    const node = $("#saveStatus");
    node.textContent = msg;
    node.style.color = isError ? "var(--bad)" : "var(--muted)";
    setTimeout(() => { if (node.textContent === msg) node.textContent = ""; }, 3500);
  }

  function saveDecision() {
    const seatId = $("#roleSelect").value;
    const action = $("#actionSelect").value;
    const indicator = $("#indicatorSelect").value;
    const link = $("#capCtrlLeg").value.trim();
    const justification = $("#justification").value.trim();

    if (!seatId) return flashStatus("Select a role first.", true);
    if (!action) return flashStatus("Choose an action.", true);
    if (!indicator) return flashStatus("Select an indicator.", true);
    if (!link) return flashStatus("Link to capability/control/legitimacy.", true);
    if (justification.length < 20) return flashStatus("Write 2‚Äì4 sentences.", true);

    state.decisions[seatId] = {
      seatId, action, indicator, conceptLink: link, justification,
      savedAt: new Date().toISOString()
    };

    localStorage.setItem(LS_KEY, JSON.stringify(getSnapshot()));
    flashStatus("Saved. Export JSON/CSV for debrief.");
  }

  function loadMyDecision() {
    const seatId = $("#roleSelect").value;
    if (!seatId) return flashStatus("Select a role to load its saved decision.", true);

    const snap = state.decisions[seatId];
    if (!snap) return flashStatus("No saved decision for this role yet.", true);

    $("#actionSelect").value = snap.action;
    $("#indicatorSelect").value = snap.indicator;
    $("#capCtrlLeg").value = snap.conceptLink;
    $("#justification").value = snap.justification;
    flashStatus("Loaded saved decision.");
  }

  function loadFromLocalStorage() {
    try{
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const snap = JSON.parse(raw);

      if (snap?.weights) setSlidersFromWeights(snap.weights);
      if (Array.isArray(snap.assignments)) state.assignments = snap.assignments;
      if (snap.decisions && typeof snap.decisions === "object") state.decisions = snap.decisions;
      if (snap.timer?.remainingSec != null) state.timer.remainingSec = snap.timer.remainingSec;
      if (snap.meta?.phase) setPhase(String(snap.meta.phase));
    } catch(e) {
      // ignore bad localStorage
    }
  }

  function download(filename, text) {
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportJSON() {
    download("platform-shock-simulation.json", JSON.stringify(getSnapshot(), null, 2));
  }

  function csv(x) {
    const s = String(x ?? "");
    if (/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  function exportCSV() {
    const snap = getSnapshot();
    const rows = [];

    const decisions = Object.values(snap.decisions || {});
    rows.push(["seatId","roleName","action","indicator","conceptLink","justification","savedAt"].join(","));
    for (const d of decisions) {
      const roleName = state.seats.find(s=>s.id===d.seatId)?.name || d.seatId;
      rows.push([
        csv(d.seatId),
        csv(roleName),
        csv(d.action),
        csv(d.indicator),
        csv(d.conceptLink),
        csv(d.justification),
        csv(d.savedAt)
      ].join(","));
    }

    rows.push("");
    rows.push(["WEIGHTS","rnd","dep","reg","work"].join(","));
    rows.push(["", snap.weights.rnd.toFixed(4), snap.weights.dep.toFixed(4), snap.weights.reg.toFixed(4), snap.weights.work.toFixed(4)].join(","));

    rows.push("");
    rows.push(["RANKING","country","score"].join(","));
    snap.ranking.forEach((r,i)=>rows.push([String(i+1), csv(r.country), String(r.score)].join(",")));

    download("platform-shock-decisions.csv", rows.join("\n"));
  }

  const debriefText =
`Debrief (5 minutes)

1) Constraint and choice:
   What was the first option you ruled out, and why?

2) Capability vs leverage:
   Who had the most capability, and did that translate into the widest range of options?

3) Quant grounding:
   Which indicator did you rely on? If we re-weighted that indicator, how would your choice change?

4) Authority and legitimacy:
   Who had the authority to define acceptable use of the technology?

5) Small-state strategy:
   For small states, what strategy compensated for dependence rather than eliminating it?`;

  async function copyDebriefPrompts() {
    try{
      await navigator.clipboard.writeText(debriefText);
      flashStatus("Debrief prompts copied to clipboard.");
    } catch(e) {
      download("platform-shock-debrief.txt", debriefText);
      flashStatus("Clipboard blocked; downloaded prompts instead.");
    }
  }

  function init() {
    renderTable();
    loadFromLocalStorage();
    renderRoles();
    onWeightsChanged();
    updateTimerUI();

    ["#wRnD","#wDep","#wReg","#wWork"].forEach(sel => {
      $(sel).addEventListener("input", onWeightsChanged);
    });

    $("#resetWeights").addEventListener("click", resetWeights);
    $("#randomWeights").addEventListener("click", randomWeights);

    $("#assignRolesBtn").addEventListener("click", autoAssignRoles);
    $("#clearRolesBtn").addEventListener("click", clearRoles);

    $("#startBtn").addEventListener("click", startTimer);
    $("#pauseBtn").addEventListener("click", pauseTimer);
    $("#resetBtn").addEventListener("click", resetTimer);

    $("#saveDecisionBtn").addEventListener("click", saveDecision);
    $("#loadMyDecisionBtn").addEventListener("click", loadMyDecision);

    $("#exportJsonBtn").addEventListener("click", exportJSON);
    $("#exportCsvBtn").addEventListener("click", exportCSV);
    $("#copyDebriefBtn").addEventListener("click", copyDebriefPrompts);

    $("#exportPill").addEventListener("click", () => {
      $("#decisionCard").scrollIntoView({ behavior: "smooth", block: "start" });
    });

    $("#roleSelect").addEventListener("change", () => {
      const seatId = $("#roleSelect").value;
      const snap = state.decisions[seatId];
      if (snap) {
        $("#actionSelect").value = snap.action;
        $("#indicatorSelect").value = snap.indicator;
        $("#capCtrlLeg").value = snap.conceptLink;
        $("#justification").value = snap.justification;
      } else {
        $("#actionSelect").value = "";
        $("#indicatorSelect").value = "";
        $("#capCtrlLeg").value = "";
        $("#justification").value = "";
      }
    });

    window.addEventListener("beforeunload", () => {
      try { localStorage.setItem(LS_KEY, JSON.stringify(getSnapshot())); } catch(e) {}
    });
  }

  init();
})();
</script>
</body>
</html>
