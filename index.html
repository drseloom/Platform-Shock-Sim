<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Platform Shock — The Geopolitics of Technology (Teaching Demo)</title>
  <style>
    :root{
      --bg:#0b0c10; --panel:#11131a; --panel2:#151826; --text:#e8eaf0; --muted:#a6adbb;
      --accent:#7aa2ff; --good:#41d17d; --warn:#ffcc66; --bad:#ff6b6b; --line:#262a3a;
      --chip:#1b1f2f;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    * { box-sizing: border-box; }
    body{
      margin:0; background: radial-gradient(1200px 800px at 20% 0%, rgba(122,162,255,.18), transparent 55%),
                         radial-gradient(1000px 700px at 90% 20%, rgba(65,209,125,.10), transparent 50%),
                         var(--bg);
      color:var(--text); font-family:var(--sans);
    }
    header{
      padding: 18px 18px 6px;
      position: sticky; top:0; z-index:20;
      background: linear-gradient(to bottom, rgba(11,12,16,.92), rgba(11,12,16,.62));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(38,42,58,.6);
    }
    header .top{
      display:flex; gap:14px; align-items:flex-start; justify-content:space-between; flex-wrap:wrap;
      max-width: 1200px; margin: 0 auto;
    }
    h1{ margin:0; font-size: 18px; letter-spacing:.2px; }
    .subtitle{ margin-top:4px; color:var(--muted); font-size: 13px; max-width: 820px; line-height:1.35; }
    .pillrow{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .pill{
      background: rgba(27,31,47,.9);
      border: 1px solid rgba(38,42,58,.9);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      display:flex; align-items:center; gap:8px;
    }
    .pill strong{ color: var(--text); font-weight:600; }
    .container{
      max-width: 1200px; margin: 16px auto 60px; padding: 0 18px;
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .container{ grid-template-columns: 1fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(17,19,26,.94), rgba(17,19,26,.84));
      border: 1px solid rgba(38,42,58,.85);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card h2{
      margin:0; padding: 14px 14px 10px;
      font-size: 14px; font-weight: 650;
      border-bottom: 1px solid rgba(38,42,58,.6);
      background: rgba(21,24,38,.55);
    }
    .card .body{ padding: 14px; }
    .muted{ color: var(--muted); }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    @media (max-width: 520px){ .grid2{ grid-template-columns: 1fr; } }
    .btnbar{ display:flex; gap:10px; flex-wrap:wrap; }
    button{
      background: rgba(122,162,255,.18);
      color: var(--text);
      border: 1px solid rgba(122,162,255,.35);
      padding: 10px 12px;
      border-radius: 12px;
      font-size: 13px;
      cursor:pointer;
      transition: transform .04s ease, background .15s ease, border .15s ease;
      user-select:none;
    }
    button:hover{ background: rgba(122,162,255,.26); }
    button:active{ transform: translateY(1px); }
    button.secondary{
      background: rgba(27,31,47,.85);
      border: 1px solid rgba(38,42,58,.85);
    }
    button.secondary:hover{ background: rgba(27,31,47,.98); }
    button.danger{
      background: rgba(255,107,107,.18);
      border: 1px solid rgba(255,107,107,.32);
    }
    button.danger:hover{ background: rgba(255,107,107,.25); }
    button.good{
      background: rgba(65,209,125,.16);
      border: 1px solid rgba(65,209,125,.32);
    }
    button.good:hover{ background: rgba(65,209,125,.24); }
    button:disabled{
      opacity:.5; cursor:not-allowed;
    }
    .table{
      width:100%;
      border-collapse: collapse;
      font-size: 12px;
    }
    .table th, .table td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(38,42,58,.7);
      text-align:left;
      vertical-align: top;
    }
    .table th{ color: var(--muted); font-weight: 650; }
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
      margin-top: 10px;
    }
    .chip{
      background: rgba(27,31,47,.9);
      border: 1px solid rgba(38,42,58,.85);
      padding: 8px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
    }
    .chip strong{ color: var(--text); font-weight: 650; }
    .sliders{
      display:grid; gap:10px;
    }
    .sliderrow{
      display:grid; grid-template-columns: 140px 1fr 52px;
      gap:10px; align-items:center;
      font-size: 12px;
      color: var(--muted);
    }
    .sliderrow label{ color: var(--muted); }
    input[type="range"]{ width:100%; }
    .num{
      font-family: var(--mono);
      color: var(--text);
      text-align:right;
      background: rgba(27,31,47,.9);
      border: 1px solid rgba(38,42,58,.85);
      border-radius: 10px;
      padding: 6px 8px;
    }
    .scorebox{
      display:grid; grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top: 12px;
    }
    .scorecard{
      background: rgba(21,24,38,.75);
      border: 1px solid rgba(38,42,58,.75);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .scorecard .label{ color: var(--muted); font-size: 12px; }
    .scorecard .value{ font-family: var(--mono); font-size: 16px; margin-top: 4px; }
    .ranklist{
      margin-top: 10px;
      display:grid; gap:8px;
    }
    .rankitem{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background: rgba(21,24,38,.65);
      border: 1px solid rgba(38,42,58,.65);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 12px;
    }
    .rankitem .left{
      display:flex; gap:10px; align-items:center; min-width: 0;
    }
    .badge{
      width: 22px; height: 22px; border-radius: 999px;
      display:flex; align-items:center; justify-content:center;
      font-size: 12px; font-family: var(--mono);
      background: rgba(122,162,255,.18);
      border: 1px solid rgba(122,162,255,.35);
      flex: 0 0 auto;
    }
    .rankitem .country{ white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
    .rankitem .score{ font-family: var(--mono); color: var(--text); }
    .scenario{
      background: rgba(21,24,38,.65);
      border: 1px solid rgba(38,42,58,.65);
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 10px;
    }
    .scenario h3{ margin:0 0 6px; font-size: 13px; }
    .scenario p{ margin:0; color: var(--muted); font-size: 12px; line-height:1.45; }
    .roles{
      display:grid; gap:10px;
    }
    .rolecard{
      background: rgba(21,24,38,.65);
      border: 1px solid rgba(38,42,58,.65);
      border-radius: 14px;
      padding: 12px;
    }
    .rolehead{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      margin-bottom: 8px;
    }
    .rolehead .name{ font-size: 13px; font-weight: 650; }
    .rolehead .tag{
      font-size: 11px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(27,31,47,.9);
      border: 1px solid rgba(38,42,58,.85);
      color: var(--muted);
      white-space:nowrap;
    }
    .rolecard ul{
      margin: 8px 0 0 18px;
      color: var(--muted);
      font-size: 12px;
      line-height: 1.35;
    }
    .inputs{
      display:grid; gap:10px;
      margin-top: 10px;
    }
    textarea, select, input[type="text"]{
      width:100%;
      background: rgba(27,31,47,.9);
      border: 1px solid rgba(38,42,58,.85);
      color: var(--text);
      border-radius: 12px;
      padding: 10px;
      font-size: 13px;
      outline:none;
    }
    textarea{ min-height: 110px; resize: vertical; }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 520px){ .row{ grid-template-columns: 1fr; } }
    .timer{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      background: rgba(21,24,38,.65);
      border: 1px solid rgba(38,42,58,.65);
      border-radius: 14px;
      padding: 10px 12px;
      margin-bottom: 10px;
    }
    .timer .tleft{ color: var(--muted); font-size: 12px; }
    .timer .tvalue{ font-family: var(--mono); font-size: 16px; }
    .progress{
      height: 10px;
      border-radius: 999px;
      background: rgba(27,31,47,.85);
      border: 1px solid rgba(38,42,58,.85);
      overflow:hidden;
      margin-top: 8px;
    }
    .bar{
      height:100%;
      width:0%;
      background: linear-gradient(90deg, rgba(122,162,255,.85), rgba(65,209,125,.85));
    }
    .footer{
      color: var(--muted);
      font-size: 12px;
      margin-top: 12px;
      line-height:1.45;
    }
    .small{ font-size: 12px; color: var(--muted); }
    .hr{
      height:1px; background: rgba(38,42,58,.6);
      margin: 12px 0;
    }
    .hidden{ display:none !important; }
    .mono{ font-family: var(--mono); }
  </style>
</head>

<body>
<header>
  <div class="top">
    <div>
      <h1>Platform Shock — Technology as Power (Teaching Demo)</h1>
      <div class="subtitle">
        A 10-minute web simulation for <span class="mono">The Geopolitics of Technology</span>.
        Students compare indicators, set weights, then make a constrained choice under a platform disruption.
      </div>
    </div>
    <div class="pillrow">
      <div class="pill"><strong>Phase</strong> <span id="phaseLabel">Setup</span></div>
      <div class="pill"><strong>Timer</strong> <span id="timerMini">--:--</span></div>
      <div class="pill"><strong>Export</strong> <span class="mono">JSON/CSV</span></div>
    </div>
  </div>
</header>

<div class="container">
  <!-- LEFT: Quant + Scenario -->
  <section class="card">
    <h2>1) Quant baseline → weighted leverage score</h2>
    <div class="body">
      <div class="small">
        Students use four indicators (illustrative values) and choose weights. The purpose is to show that “quant” can support,
        but cannot settle, political interpretation.
      </div>

      <div class="hr"></div>

      <table class="table" id="dataTable" aria-label="Technology leverage indicators table"></table>

      <div class="kpi">
        <span class="chip"><strong>Scoring:</strong> normalized 0–100</span>
        <span class="chip"><strong>Dependency:</strong> lower = better</span>
        <span class="chip"><strong>Weights:</strong> sum to 1.00</span>
      </div>

      <div class="hr"></div>

      <div class="grid2">
        <div>
          <div class="muted" style="font-size:12px; margin-bottom:8px;">Set weights (drag sliders)</div>
          <div class="sliders">
            <div class="sliderrow">
              <label for="wRnD">R&amp;D (% GDP)</label>
              <input id="wRnD" type="range" min="0" max="100" value="30" />
              <div class="num" id="wRnDVal">0.30</div>
            </div>
            <div class="sliderrow">
              <label for="wDep">Platform dependency</label>
              <input id="wDep" type="range" min="0" max="100" value="25" />
              <div class="num" id="wDepVal">0.25</div>
            </div>
            <div class="sliderrow">
              <label for="wReg">Regulatory capacity</label>
              <input id="wReg" type="range" min="0" max="100" value="25" />
              <div class="num" id="wRegVal">0.25</div>
            </div>
            <div class="sliderrow">
              <label for="wWork">Tech workforce density</label>
              <input id="wWork" type="range" min="0" max="100" value="20" />
              <div class="num" id="wWorkVal">0.20</div>
            </div>
          </div>

          <div class="scorebox">
            <div class="scorecard">
              <div class="label">Weight sum</div>
              <div class="value" id="weightSum">1.00</div>
            </div>
            <div class="scorecard">
              <div class="label">Interpretation cue</div>
              <div class="value" id="cueText" style="font-size:13px; font-family:var(--sans);">Balanced</div>
            </div>
          </div>

          <div class="btnbar" style="margin-top:12px;">
            <button class="secondary" id="resetWeights">Reset weights</button>
            <button class="secondary" id="randomWeights">Random weights</button>
          </div>
        </div>

        <div>
          <div class="muted" style="font-size:12px; margin-bottom:8px;">Ranked leverage (with your weights)</div>
          <div class="ranklist" id="rankList"></div>
          <div class="footer">
            Instructor tip: ask, “Which country moved up or down when you changed weights? What does that reveal about your theory of power?”
          </div>
        </div>
      </div>

      <div class="hr"></div>

      <div class="scenario">
        <h3>Scenario: “Platform Shock”</h3>
        <p>
          A dominant cloud/AI platform announces an immediate restriction on access for “compliance reasons” after a geopolitical dispute.
          Some actors lose model access and compute credits within <span class="mono">72 hours</span>. Others can offer alternatives, but at political cost.
        </p>
      </div>

      <div class="scenario">
        <h3>Decision task</h3>
        <p>
          Your group must choose a response (regulate, substitute, bargain, align, or stabilize). You must justify the choice using at least one indicator
          from the table and link it to <span class="mono">capability</span>, <span class="mono">control</span>, or <span class="mono">legitimacy</span>.
        </p>
      </div>
    </div>
  </section>

  <!-- RIGHT: Roles + Timer + Decisions -->
  <aside class="card">
    <h2>2) Roles, timer, decisions, and debrief export</h2>
    <div class="body">
      <div class="timer">
        <div>
          <div class="tleft">Simulation timer</div>
          <div class="tvalue" id="timerMain">--:--</div>
          <div class="progress" aria-hidden="true"><div class="bar" id="timeBar"></div></div>
        </div>
        <div class="btnbar">
          <button class="good" id="startBtn">Start 5:00</button>
          <button class="secondary" id="pauseBtn" disabled>Pause</button>
          <button class="danger" id="resetBtn">Reset</button>
        </div>
      </div>

      <div class="small">
        Use this in-class: assign roles, click <span class="mono">Start</span>, groups fill in their decision.
        You can export responses for the Q&amp;A or post-class reflection.
      </div>

      <div class="hr"></div>

      <div class="btnbar">
        <button class="secondary" id="assignRolesBtn">Auto-assign roles (10 people)</button>
        <button class="secondary" id="clearRolesBtn">Clear roles</button>
      </div>

      <div class="roles" id="rolesArea" style="margin-top:10px;"></div>

      <div class="hr"></div>

      <div class="muted" style="font-size:12px; margin-bottom:8px;">Group decision input (pick your role)</div>
      <div class="inputs">
        <div class="row">
          <select id="roleSelect" aria-label="Select role">
            <option value="">Select your role…</option>
          </select>
          <select id="actionSelect" aria-label="Select action">
            <option value="">Choose action…</option>
            <option>Regulate / mandate compliance</option>
            <option>Substitute / build domestic capacity</option>
            <option>Bargain / offer concessions for access</option>
            <option>Align / join bloc or standards regime</option>
            <option>Stabilize / diversify suppliers quietly</option>
            <option>Retaliate / restrict market access</option>
          </select>
        </div>

        <div class="row">
          <select id="indicatorSelect" aria-label="Select indicator to justify">
            <option value="">Indicator used for justification…</option>
            <option value="rnd">R&amp;D (% GDP)</option>
            <option value="dep">Foreign platform dependency (%)</option>
            <option value="reg">Regulatory capacity (0–5)</option>
            <option value="work">Tech workforce density (per 1,000)</option>
          </select>
          <input id="capCtrlLeg" type="text" placeholder="Link to: capability / control / legitimacy" aria-label="Link to concept" />
        </div>

        <textarea id="justification" placeholder="Write your justification (2–4 sentences). Include one table number and one political logic." aria-label="Justification text"></textarea>

        <div class="btnbar">
          <button class="good" id="saveDecisionBtn">Save decision</button>
          <button class="secondary" id="loadMyDecisionBtn">Load saved</button>
        </div>

        <div class="small" id="saveStatus" aria-live="polite"></div>
      </div>

      <div class="hr"></div>

      <div class="btnbar">
        <button class="secondary" id="exportJsonBtn">Export JSON</button>
        <button class="secondary" id="exportCsvBtn">Export CSV</button>
        <button class="secondary" id="copyDebriefBtn">Copy debrief prompts</button>
      </div>

      <div class="footer">
        Debrief prompts are built-in and mapped to your teaching demo: constraints, capability vs leverage, indicator choice, authority, and small-state strategy.
      </div>
    </div>
  </aside>
</div>

<script>
(() => {
  // ----------------------------
  // Data (illustrative values)
  // ----------------------------
  const countries = [
    { country: "United States", rnd: 3.5, dep: 20, reg: 4.5, work: 9.0 },
    { country: "China",         rnd: 2.6, dep: 15, reg: 4.0, work: 7.5 },
    { country: "European Union",rnd: 2.3, dep: 35, reg: 5.0, work: 6.8 },
    { country: "UAE",           rnd: 1.5, dep: 55, reg: 3.5, work: 4.2 },
    { country: "Qatar",         rnd: 1.0, dep: 60, reg: 3.0, work: 3.8 },
    { country: "India",         rnd: 0.7, dep: 40, reg: 2.5, work: 5.0 }
  ];

  const metricMeta = {
    rnd:  { label: "R&D Expenditure (% GDP)", higherBetter: true },
    dep:  { label: "Foreign Platform Dependency (%)", higherBetter: false },
    reg:  { label: "Regulatory Capacity (0–5)", higherBetter: true },
    work: { label: "Tech Workforce Density (per 1,000)", higherBetter: true }
  };

  // ----------------------------
  // DOM helpers
  // ----------------------------
  const $ = (sel) => document.querySelector(sel);
  const el = (tag, attrs = {}, children = []) => {
    const n = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k === "class") n.className = v;
      else if (k === "html") n.innerHTML = v;
      else if (k.startsWith("on") && typeof v === "function") n.addEventListener(k.slice(2), v);
      else n.setAttribute(k, v);
    }
    for (const c of children) n.appendChild(typeof c === "string" ? document.createTextNode(c) : c);
    return n;
  };

  // ----------------------------
  // Render data table
  // ----------------------------
  function renderTable() {
    const table = $("#dataTable");
    table.innerHTML = "";
    const thead = el("thead");
    const trh = el("tr");
    trh.appendChild(el("th", {}, ["Country"]));
    trh.appendChild(el("th", {}, ["R&D (% GDP)"]));
    trh.appendChild(el("th", {}, ["Platform dependency (%)"]));
    trh.appendChild(el("th", {}, ["Reg. capacity (0–5)"]));
    trh.appendChild(el("th", {}, ["Tech workforce (/1,000)"]));
    thead.appendChild(trh);
    table.appendChild(thead);

    const tbody = el("tbody");
    for (const r of countries) {
      const tr = el("tr");
      tr.appendChild(el("td", {}, [r.country]));
      tr.appendChild(el("td", {}, [String(r.rnd)]));
      tr.appendChild(el("td", {}, [String(r.dep)]));
      tr.appendChild(el("td", {}, [String(r.reg)]));
      tr.appendChild(el("td", {}, [String(r.work)]));
      tbody.appendChild(tr);
    }
    table.appendChild(tbody);
  }

  // ----------------------------
  // Normalization & scoring
  // Score is 0–100 for each metric, then weighted average.
  // For dep, lower is better, so invert.
  // ----------------------------
  function minMax(metric) {
    const vals = countries.map(c => c[metric]);
    return { min: Math.min(...vals), max: Math.max(...vals) };
  }

  function norm(value, metric) {
    const { min, max } = minMax(metric);
    if (max === min) return 50; // degenerate
    let x = (value - min) / (max - min);
    if (!metricMeta[metric].higherBetter) x = 1 - x;
    return x * 100;
  }

  function getWeights() {
    // sliders store 0..100; normalize to sum 1.00
    const raw = {
      rnd: Number($("#wRnD").value),
      dep: Number($("#wDep").value),
      reg: Number($("#wReg").value),
      work: Number($("#wWork").value)
    };
    const sum = raw.rnd + raw.dep + raw.reg + raw.work;
    const w = {};
    for (const k of Object.keys(raw)) w[k] = sum ? raw[k]/sum : 0.25;
    return { w, sum };
  }

  function updateWeightDisplays() {
    const { w, sum } = getWeights();
    $("#wRnDVal").textContent = w.rnd.toFixed(2);
    $("#wDepVal").textContent = w.dep.toFixed(2);
    $("#wRegVal").textContent = w.reg.toFixed(2);
    $("#wWorkVal").textContent = w.work.toFixed(2);
    $("#weightSum").textContent = (w.rnd+w.dep+w.reg+w.work).toFixed(2);

    // cue text: show which weight dominates
    const entries = Object.entries(w).sort((a,b)=>b[1]-a[1]);
    const [topK, topV] = entries[0];
    const cueMap = {
      rnd: "Innovation-heavy (capability)",
      dep: "Autonomy-heavy (control via dependence)",
      reg: "Governance-heavy (authority/legitimacy)",
      work: "Human-capital-heavy (capacity scaling)"
    };
    $("#cueText").textContent = (topV >= 0.40) ? cueMap[topK] : "Balanced";
  }

  function computeScores() {
    const { w } = getWeights();
    const scored = countries.map(c => {
      const s = (
        norm(c.rnd,"rnd")  * w.rnd +
        norm(c.dep,"dep")  * w.dep +
        norm(c.reg,"reg")  * w.reg +
        norm(c.work,"work")* w.work
      );
      return { ...c, score: s };
    }).sort((a,b)=>b.score - a.score);
    return scored;
  }

  function renderRanks() {
    const list = $("#rankList");
    list.innerHTML = "";
    const scored = computeScores();
    scored.forEach((c, idx) => {
      list.appendChild(
        el("div", { class:"rankitem" }, [
          el("div", { class:"left" }, [
            el("div", { class:"badge" }, [String(idx+1)]),
            el("div", { class:"country" }, [c.country])
          ]),
          el("div", { class:"score" }, [c.score.toFixed(1)])
        ])
      );
    });
  }

  // ----------------------------
  // Weights controls
  // ----------------------------
  function setSlidersFromWeights(w) {
    // set raw approx by multiplying by 100 and adjusting to sum 100
    const raw = {
      rnd: Math.round(w.rnd*100),
      dep: Math.round(w.dep*100),
      reg: Math.round(w.reg*100),
      work: Math.round(w.work*100)
    };
    // fix rounding error to sum 100
    const keys = ["rnd","dep","reg","work"];
    let s = keys.reduce((acc,k)=>acc+raw[k],0);
    while (s !== 100) {
      const k = keys[Math.floor(Math.random()*keys.length)];
      raw[k] += (s > 100 ? -1 : 1);
      s = keys.reduce((acc,kk)=>acc+raw[kk],0);
    }
    $("#wRnD").value = raw.rnd;
    $("#wDep").value = raw.dep;
    $("#wReg").value = raw.reg;
    $("#wWork").value = raw.work;
  }

  function resetWeights() {
    $("#wRnD").value = 30;
    $("#wDep").value = 25;
    $("#wReg").value = 25;
    $("#wWork").value = 20;
    onWeightsChanged();
  }

  function randomWeights() {
    const r = [Math.random(),Math.random(),Math.random(),Math.random()];
    const sum = r.reduce((a,b)=>a+b,0);
    setSlidersFromWeights({ rnd:r[0]/sum, dep:r[1]/sum, reg:r[2]/sum, work:r[3]/sum });
    onWeightsChanged();
  }

  function onWeightsChanged() {
    updateWeightDisplays();
    renderRanks();
  }

  // ----------------------------
  // Simulation roles
  // ----------------------------
  const roleTemplates = [
    {
      id: "US",
      name: "Large Tech-Producing State A (US-like)",
      tag: "State",
      bullets: [
        "High capability: R&D + workforce.",
        "Can threaten export controls / deny access.",
        "Trade-off: credibility vs market backlash."
      ]
    },
    {
      id: "CN",
      name: "Large Tech-Producing State B (China-like)",
      tag: "State",
      bullets: [
        "Strong scaling capacity + domestic market.",
        "Can offer substitute platforms, but political strings.",
        "Trade-off: autonomy vs global legitimacy."
      ]
    },
    {
      id: "SM1",
      name: "Small, capital-rich state (Gulf-like) — Group 1",
      tag: "State",
      bullets: [
        "High dependence on foreign platforms.",
        "Can buy redundancy, sign MOUs, diversify suppliers.",
        "Trade-off: speed vs sovereignty and alignment."
      ]
    },
    {
      id: "SM2",
      name: "Small, capital-rich state (Gulf-like) — Group 2",
      tag: "State",
      bullets: [
        "Seeks reputation and regime stability.",
        "Can invest in compute, data centers, and standards.",
        "Trade-off: openness vs control and legitimacy."
      ]
    },
    {
      id: "PF1",
      name: "Platform Firm A (Cloud/AI provider)",
      tag: "Firm",
      bullets: [
        "Controls access through terms-of-service and compliance.",
        "Can offer exceptions, throttling, or new pricing.",
        "Trade-off: market share vs regulatory risk."
      ]
    },
    {
      id: "PF2",
      name: "Platform Firm B (Competitor / alternative provider)",
      tag: "Firm",
      bullets: [
        "Can absorb demand displaced by the shock.",
        "May offer migration tools and credits.",
        "Trade-off: rapid growth vs geopolitical exposure."
      ]
    },
    {
      id: "REG1",
      name: "Regulator / Standards Bloc A (EU-like)",
      tag: "Institution",
      bullets: [
        "Sets compliance terms; claims legitimacy through law.",
        "Can impose fines, transparency rules, audit regimes.",
        "Trade-off: innovation concerns vs public authority."
      ]
    },
    {
      id: "REG2",
      name: "International Institution / Multilateral Forum",
      tag: "Institution",
      bullets: [
        "Can convene, coordinate, and propose norms.",
        "Limited enforcement; relies on buy-in.",
        "Trade-off: inclusivity vs decisive action."
      ]
    }
  ];

  // For a 10-person room: create up to 10 “seats” by duplicating some roles.
  function buildSeatsForTen() {
    // 8 templates + 2 duplicates (small state + platform firm) for 10.
    const seats = [...roleTemplates];
    seats.push({ ...roleTemplates.find(r=>r.id==="SM1"), id:"SM1B", name:"Small, capital-rich state (Gulf-like) — Group 3" });
    seats.push({ ...roleTemplates.find(r=>r.id==="PF1"), id:"PF1B", name:"Platform Firm A (Cloud/AI provider) — Group 2" });
    return seats;
  }

  const state = {
    phase: "Setup",
    seats: buildSeatsForTen(),
    assignments: [],  // {seatId, participantName}
    decisions: {},    // seatId -> decision object
    timer: { totalSec: 300, remainingSec: 300, running: false, startedAt: null, interval: null }
  };

  function setPhase(p) {
    state.phase = p;
    $("#phaseLabel").textContent = p;
  }

  function renderRoles() {
    const area = $("#rolesArea");
    area.innerHTML = "";

    const assignedMap = new Map(state.assignments.map(a => [a.seatId, a.participantName]));
    state.seats.forEach(seat => {
      const who = assignedMap.get(seat.id) || "";
      const card = el("div", { class:"rolecard" }, [
        el("div", { class:"rolehead" }, [
          el("div", { class:"name" }, [seat.name]),
          el("div", { class:"tag" }, [seat.tag + (who ? ` • ${who}` : "")])
        ]),
        el("div", { class:"small" }, ["Constraints & options:"]),
        el("ul", {}, seat.bullets.map(b => el("li", {}, [b])))
      ]);
      area.appendChild(card);
    });

    // role select options
    const roleSel = $("#roleSelect");
    const current = roleSel.value;
    roleSel.innerHTML = `<option value="">Select your role…</option>`;
    state.seats.forEach(seat => {
      const opt = document.createElement("option");
      opt.value = seat.id;
      opt.textContent = seat.name;
      roleSel.appendChild(opt);
    });
    roleSel.value = current && state.seats.some(s=>s.id===current) ? current : "";
  }

  function autoAssignRoles() {
    // Assign generic participants P1..P10 (in-class you can rename quickly)
    state.assignments = [];
    const names = Array.from({length: 10}, (_,i)=>`P${i+1}`);
    // shuffle seats
    const shuffled = [...state.seats].sort(()=>Math.random()-0.5);
    for (let i=0; i<Math.min(names.length, shuffled.length); i++) {
      state.assignments.push({ seatId: shuffled[i].id, participantName: names[i] });
    }
    renderRoles();
    flashStatus("Roles assigned (P1–P10). You can edit names in exported JSON if needed.");
  }

  function clearRoles() {
    state.assignments = [];
    renderRoles();
    flashStatus("Roles cleared.");
  }

  // ----------------------------
  // Timer
  // ----------------------------
  function fmtTime(sec) {
    const m = Math.floor(sec/60);
    const s = sec % 60;
    return `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
  }

  function updateTimerUI() {
    $("#timerMain").textContent = fmtTime(state.timer.remainingSec);
    $("#timerMini").textContent = fmtTime(state.timer.remainingSec);
    const pct = 100 * (1 - state.timer.remainingSec / state.timer.totalSec);
    $("#timeBar").style.width = `${Math.min(100, Math.max(0, pct))}%`;
  }

  function startTimer() {
    if (state.timer.running) return;
    setPhase("Decision (5 minutes)");
    state.timer.running = true;
    $("#startBtn").disabled = true;
    $("#pauseBtn").disabled = false;

    const tick = () => {
      state.timer.remainingSec = Math.max(0, state.timer.remainingSec - 1);
      updateTimerUI();
      if (state.timer.remainingSec === 0) {
        stopTimer();
        setPhase("Debrief");
        flashStatus("Time. Move to debrief prompts.");
      }
    };

    state.timer.interval = setInterval(tick, 1000);
  }

  function stopTimer() {
    if (!state.timer.running) return;
    state.timer.running = false;
    clearInterval(state.timer.interval);
    state.timer.interval = null;
    $("#startBtn").disabled = false;
    $("#pauseBtn").disabled = true;
  }

  function pauseTimer() {
    if (!state.timer.running) return;
    stopTimer();
    setPhase("Paused");
  }

  function resetTimer() {
    stopTimer();
    state.timer.remainingSec = state.timer.totalSec;
    updateTimerUI();
    setPhase("Setup");
  }

  // ----------------------------
  // Decisions (saved in localStorage)
  // ----------------------------
  const LS_KEY = "platform_shock_sim_v1";

  function getSnapshot() {
    const weights = getWeights().w;
    const ranking = computeScores().map(c => ({ country: c.country, score: Number(c.score.toFixed(1)) }));
    return {
      meta: {
        title: "Platform Shock — Geopolitics of Technology",
        createdAt: new Date().toISOString(),
        phase: state.phase
      },
      data: { countries },
      weights,
      ranking,
      assignments: state.assignments,
      decisions: state.decisions,
      timer: { totalSec: state.timer.totalSec, remainingSec: state.timer.remainingSec }
    };
  }

  function saveDecision() {
    const seatId = $("#roleSelect").value;
    const action = $("#actionSelect").value;
    const indicator = $("#indicatorSelect").value;
    const link = $("#capCtrlLeg").value.trim();
    const justification = $("#justification").value.trim();

    if (!seatId) return flashStatus("Select a role first.", true);
    if (!action) return flashStatus("Choose an action.", true);
    if (!indicator) return flashStatus("Select an indicator.", true);
    if (!link) return flashStatus("Link your logic to capability/control/legitimacy.", true);
    if (justification.length < 20) return flashStatus("Write a short justification (at least ~20 characters).", true);

    const decision = {
      seatId,
      action,
      indicator,
      conceptLink: link,
      justification,
      savedAt: new Date().toISOString()
    };
    state.decisions[seatId] = decision;
    localStorage.setItem(LS_KEY, JSON.stringify(getSnapshot()));
    flashStatus("Saved. You can export JSON/CSV for debrief.");
  }

  function loadMyDecision() {
    const seatId = $("#roleSelect").value;
    if (!seatId) return flashStatus("Select a role to load its saved decision.", true);

    const snap = state.decisions[seatId];
    if (!snap) return flashStatus("No saved decision for this role yet.", true);

    $("#actionSelect").value = snap.action;
    $("#indicatorSelect").value = snap.indicator;
    $("#capCtrlLeg").value = snap.conceptLink;
    $("#justification").value = snap.justification;
    flashStatus("Loaded saved decision.");
  }

  function loadFromLocalStorage() {
    try{
      const raw = localStorage.getItem(LS_KEY);
      if (!raw) return;
      const snap = JSON.parse(raw);
      if (snap?.weights) setSlidersFromWeights(snap.weights);
      if (Array.isArray(snap.assignments)) state.assignments = snap.assignments;
      if (snap.decisions && typeof snap.decisions === "object") state.decisions = snap.decisions;
      if (snap.timer?.remainingSec != null) state.timer.remainingSec = snap.timer.remainingSec;
    } catch(e) {
      // ignore
    }
  }

  function flashStatus(msg, isError=false) {
    const el = $("#saveStatus");
    el.textContent = msg;
    el.style.color = isError ? "var(--bad)" : "var(--muted)";
    setTimeout(() => { if (el.textContent === msg) el.textContent = ""; }, 3500);
  }

  // ----------------------------
  // Export
  // ----------------------------
  function download(filename, text) {
    const blob = new Blob([text], { type: "text/plain;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function exportJSON() {
    const snap = getSnapshot();
    download("platform-shock-simulation.json", JSON.stringify(snap, null, 2));
  }

  function exportCSV() {
    // Flatten decisions + weights + ranking
    const snap = getSnapshot();
    const rows = [];

    // Decisions
    const decisions = Object.values(snap.decisions || {});
    if (decisions.length === 0) {
      rows.push(["seatId","roleName","action","indicator","conceptLink","justification","savedAt"].join(","));
    } else {
      rows.push(["seatId","roleName","action","indicator","conceptLink","justification","savedAt"].join(","));
      for (const d of decisions) {
        const roleName = state.seats.find(s=>s.id===d.seatId)?.name || d.seatId;
        rows.push([
          csv(d.seatId),
          csv(roleName),
          csv(d.action),
          csv(d.indicator),
          csv(d.conceptLink),
          csv(d.justification),
          csv(d.savedAt)
        ].join(","));
      }
    }

    rows.push("");
    rows.push(["WEIGHTS","rnd","dep","reg","work"].join(","));
    rows.push(["", snap.weights.rnd.toFixed(4), snap.weights.dep.toFixed(4), snap.weights.reg.toFixed(4), snap.weights.work.toFixed(4)].join(","));

    rows.push("");
    rows.push(["RANKING","country","score"].join(","));
    snap.ranking.forEach((r,i)=>rows.push([String(i+1), csv(r.country), String(r.score)].join(",")));

    download("platform-shock-decisions.csv", rows.join("\n"));
  }

  function csv(x) {
    const s = String(x ?? "");
    if (/[,"\n]/.test(s)) return `"${s.replace(/"/g,'""')}"`;
    return s;
  }

  // ----------------------------
  // Debrief prompts
  // ----------------------------
  const debriefText =
`Debrief (5 minutes)

1) Constraint and choice:
   What was the first option you ruled out, and why? Was the constraint technological, economic, regulatory, or political?

2) Capability vs leverage:
   Who had the most capability, and did that translate into the widest range of options? Who had fewer capabilities but retained leverage, and how?

3) Quant grounding:
   Which indicator did you rely on? If we re-weighted that indicator, how would your choice change?

4) Authority and legitimacy:
   Who had the authority to define acceptable use of the technology? Did that authority come from law, market position, alliance politics, or norms?

5) Small-state strategy:
   For small states, what strategy compensated for dependence rather than eliminating it? What does that imply about interdependence as influence vs vulnerability?`;

  async function copyDebriefPrompts() {
    try{
      await navigator.clipboard.writeText(debriefText);
      flashStatus("Debrief prompts copied to clipboard.");
    } catch(e) {
      // fallback: download
      download("platform-shock-debrief.txt", debriefText);
      flashStatus("Clipboard blocked; downloaded debrief prompts instead.");
    }
  }

  // ----------------------------
  // Wire events
  // ----------------------------
  function init() {
    renderTable();
    loadFromLocalStorage();
    renderRoles();
    onWeightsChanged();
    updateTimerUI();

    ["#wRnD","#wDep","#wReg","#wWork"].forEach(sel => {
      $(sel).addEventListener("input", () => onWeightsChanged());
    });

    $("#resetWeights").addEventListener("click", resetWeights);
    $("#randomWeights").addEventListener("click", randomWeights);

    $("#assignRolesBtn").addEventListener("click", autoAssignRoles);
    $("#clearRolesBtn").addEventListener("click", clearRoles);

    $("#startBtn").addEventListener("click", startTimer);
    $("#pauseBtn").addEventListener("click", pauseTimer);
    $("#resetBtn").addEventListener("click", resetTimer);

    $("#saveDecisionBtn").addEventListener("click", saveDecision);
    $("#loadMyDecisionBtn").addEventListener("click", loadMyDecision);

    $("#exportJsonBtn").addEventListener("click", exportJSON);
    $("#exportCsvBtn").addEventListener("click", exportCSV);
    $("#copyDebriefBtn").addEventListener("click", copyDebriefPrompts);

    // When a role is selected, prefill with saved decision if any
    $("#roleSelect").addEventListener("change", () => {
      const seatId = $("#roleSelect").value;
      const snap = state.decisions[seatId];
      if (snap) {
        $("#actionSelect").value = snap.action;
        $("#indicatorSelect").value = snap.indicator;
        $("#capCtrlLeg").value = snap.conceptLink;
        $("#justification").value = snap.justification;
      } else {
        $("#actionSelect").value = "";
        $("#indicatorSelect").value = "";
        $("#capCtrlLeg").value = "";
        $("#justification").value = "";
      }
    });

    // Persist weights + assignments frequently (lightweight)
    window.addEventListener("beforeunload", () => {
      try { localStorage.setItem(LS_KEY, JSON.stringify(getSnapshot())); } catch(e) {}
    });
  }

  init();
})();
</script>
</body>
</html>
